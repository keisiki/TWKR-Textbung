@TURN_RESET
;처녀상실
FOR LOCAL, 0, CHARANUM
	SIF !TCVAR:LOCAL:파과
		CONTINUE
	IF TCVAR:LOCAL:파과 == 1
		IF TALENT:LOCAL:처녀 == 1
			TALENT:LOCAL:처녀 = 0
			EX:LOCAL:처녀상실체크 = 1
		ENDIF
		IF LOCAL && (FLAG:시간정지 || TCVAR:LOCAL:만취 || CFLAG:LOCAL:수면)
			TALENT:LOCAL:처녀 = -1
			EX:LOCAL:처녀상실체크 = 1
			CFLAG:LOCAL:292 = 1
		ENDIF
	ENDIF
	IF TCVAR:LOCAL:파과 == 2 && TALENT:LOCAL:처녀 == 2
		TALENT:LOCAL:처녀 = 0
		EX:LOCAL:처녀상실체크 = 2
	ENDIF
	IF TCVAR:LOCAL:파과 == -1 && TALENT:LOCAL:처녀 == -1
		TALENT:LOCAL:처녀 = 0
		EX:LOCAL:처녀상실체크 = 1
	ENDIF
NEXT

;동정상실
IF HAS_PENIS(MASTER)
	SELECTCASE SELECTCOM
		CASE 60, 61, 65, 67, 68, 320, 322
			TALENT:MASTER:1 |= 1
		CASE 62, 63, 66, 69, 70, 323
			TALENT:MASTER:1 |= 2
	ENDSELECT
ENDIF
IF HAS_PENIS(TARGET)
	SELECTCASE SELECTCOM
		CASE 64
			TALENT:1 |= 1
		CASE 92, 93, 94
			TALENT:1 |= 2
		CASE 71
			IF MASTER_POSE(SET_V, SET_P, 1)
				TALENT:1 |= 2
			ELSE
				TALENT:1 |= 1
			ENDIF
	ENDSELECT
ENDIF

;키스 성공
;합의 취득
SIF (SELECTCOM == 312 || SELECTCOM == 602) && TFLAG:193 != 99 && !CFLAG:MASTER:장난
	SETBIT CFLAG:기정사실, 0

;고백 성공
;연인 취득
IF SELECTCOM == 352 && TFLAG:193
	SETBIT CFLAG:기정사실, 2
	SETBIT CFLAG:MASTER:기정사실, 2
	TALENT:MASTER:연인 = 1
	CALL SET_연인(NO:TARGET)
	;섹프 삭제
	IF TALENT:TARGET:섹프 == 1
		TALENT:TARGET:섹프 = 0
	ENDIF
ENDIF
;; 프로포즈 성공
IF SELECTCOM == 380 && TFLAG:193
	SETBIT CFLAG:기정사실, 5
	SETBIT CFLAG:MASTER:기정사실, 5
	SETBIT TALENT:연인,1
	CALL SET_아내(NO:TARGET)
	ITEM:약혼반지=0
	FLAG:엔딩여부=1
	;섹프 삭제
	IF TALENT:TARGET:섹프 == 1
		TALENT:TARGET:섹프 = 0
	ENDIF
ENDIF

;식사
SIF SELECTCOM == 414 || SELECTCOM == 415
	CALL RESET_DISH
	
;デート道中の進行
IF TFLAG:데이트도중 > 1000
	;開始時は+1000して設定値に戻すだけ
	TFLAG:데이트도중 -= 1000
ELSEIF TFLAG:데이트도중
	SIF !CFLAG:MASTER:우후후
		TFLAG:데이트도중 = TFLAG:데이트도중 - TIME_PROGRESS(TIME:1)
	IF TFLAG:데이트도중 <= 0
		PRINTFORMW %DATENAME_PLACE()%에 도착했습니다
		TFLAG:데이트도중 = 0
		CFLAG:MASTER:현재위치 = GET_ENTRANCE(CFLAG:MASTER:데이트중)
		CFLAG:(FLAG:데이트상대):현재위치 = CFLAG:MASTER:현재위치
	ENDIF
ENDIF


;조교 이력을 1 턴 보존
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:현재위치 == SUKIMA()
		CONTINUE
	TCVAR:LOCAL:110 = TCVAR:LOCAL:10
	TCVAR:LOCAL:112 = TCVAR:LOCAL:12

	SIF TCVAR:LOCAL:102
		TCVAR:LOCAL:102 --
	SIF !TCVAR:LOCAL:102
		TCVAR:LOCAL:103 = -1
	SIF TCVAR:LOCAL:104
		TCVAR:LOCAL:104 --
	SIF !TCVAR:LOCAL:104
		TCVAR:LOCAL:105 = -1
	;체위의 보존
	FOR LOCAL:1, 1, 11
		TEQUIP:LOCAL:(110 + LOCAL:1) = TEQUIP:LOCAL:(100 + LOCAL:1)
	NEXT
	;몸의자세제어
	IF TCVAR:LOCAL:몸의자세제어
		TCVAR:LOCAL:몸의자세제어 --
		SIF TCVAR:LOCAL:몸의자세제어 == 0
			TCVAR:LOCAL:몸의자세 = 0
	ENDIF
	;위치관계제어
	IF TCVAR:LOCAL:위치관계제어
		TCVAR:LOCAL:위치관계제어 --
		SIF TCVAR:LOCAL:위치관계제어 == 0
			TCVAR:LOCAL:위치관계 = 0
	ENDIF
	;내친 김에 사정 처리용 캐릭터라인 변수의 초기화
	CSTR:LOCAL:10 = /
	CSTR:LOCAL:11 = /
	CSTR:LOCAL:범용이펙트 =
	;복장 플래그
	IF FLAG:시간정지 == 1
	ELSE
		CALL CLOTHES_SETTING_TRAIN(LOCAL)
	ENDIF
	IF BATHROOM(CFLAG:LOCAL:현재위치) && GET_MAPID(CFLAG:LOCAL:현재위치) == MAIN_MAP
		;목욕탕 플래그는 MOVEMENT공통처리에 이동했습니다
;		CFLAG:LOCAL:목욕탕 = 0
		RESET_STAIN LOCAL
		CFLAG:LOCAL:질내사정 = 0
		CFLAG:LOCAL:애널사정 = 0
		CFLAG:LOCAL:구내정액 = 0
		CFLAG:LOCAL:안면정액 = 0
		CFLAG:LOCAL:손에정액 = 0
	ELSEIF CFLAG:LOCAL:목욕탕 > 120 && !CFLAG:LOCAL:우후후
		STAIN:LOCAL:4 |= 더러운_애널
	ENDIF
NEXT
;BASE의 변동
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:현재위치 == SUKIMA()
		CONTINUE
	;발기도
	;가산 후
	CFLAG:LOCAL:발기도2 = BASE:LOCAL:발기
	BASE:LOCAL:발기 = MIN(MAXBASE:LOCAL:발기, BASE:LOCAL:발기)
	IF NOWEX:LOCAL:사정
		IF !MASTER_POSE(SET_V, SET_P) && !MASTER_POSE(SET_A, 1)
			BASE:LOCAL:발기 = BASE:LOCAL:발기 * (ABL:LOCAL:욕망 + 1) * (BASE:LOCAL:정력 + 200) / ((MAXBASE:LOCAL:정력 + 200) * (ABL:LOCAL:욕망 + 10))
		ELSE
			BASE:LOCAL:발기 = 1000
		ENDIF
	ENDIF
NEXT

SIF CFLAG:MASTER:우후후
	CALL 우후후안특수이벤트

;플래그의 리셋
TFLAG:192 = 0
TFLAG:193 = 0
TFLAG:194 = 0
TSTR:2 = 


;TCVAR의 리셋
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:현재위치 == SUKIMA()
		CONTINUE
	FOR LOCAL:1, 0, 100
		TCVAR:LOCAL:(LOCAL:1) = 0
	NEXT
;삽입 이력
	TCVAR:LOCAL:100 = TEQUIP:LOCAL:50
	TCVAR:LOCAL:101 = TEQUIP:LOCAL:51
NEXT

TFLAG:110 = TCVAR:MASTER:친해져

;FIRSTTIME에 SELECTCOM를 처넣는다
CALLF FIRSTTIME(SELECTCOM)
FOR LOCAL, 1, CHARANUM
	SIF EXP_UP(15, LOCAL)
		CALLF FIRSTTIME("정음", 0, LOCAL)
NEXT
;사정장소
FOR LOCAL:1, 0, 60
	IF GETBIT(TFLAG:1, LOCAL:1)
		LOCALS = "사정"{LOCAL:1}
		CALLF FIRSTTIME(LOCALS, 0, TARGET)
	ENDIF
NEXT
PREVCOM = SELECTCOM
;파생 커맨드의 이력
TFLAG:151 = TFLAG:50
;전회의 TARGET
IF TFLAG:전회커맨드결과 > 0
	TFLAG:103 = TARGET
	TFLAG:150 = ASSIPLAY
ENDIF

;경험치취표시용
FOR LOCAL, 0, CHARANUM
	SIF CFLAG:LOCAL:출금||TALENT:LOCAL:사망
		CONTINUE
	;현재위치의 보존
	CFLAG:LOCAL:전턴위치 = CFLAG:LOCAL:현재위치
	FOR LOCAL:1, 0, 100
		TCVAR:LOCAL:(400 + LOCAL:1) = EXP:LOCAL:(LOCAL:1)
	NEXT
NEXT
IF BATHCHECK(CFLAG:MASTER:현재위치) && !FLAG:시간정지 && AT_HOME(MASTER)
	FOR LOCAL, 1, CHARANUM
		SIF 목욕탕추방조건(LOCAL) && CFLAG:LOCAL:현재위치 == CFLAG:MASTER:현재위치
			CALL 목욕탕으로부터내쫒아(LOCAL)
		;MASTERが追い出されたならループ終了
		SIF BATHCHECK(CFLAG:MASTER:현재위치) == 0
			BREAK
	NEXT
ENDIF
;TFLAG의 리셋
VARSET TFLAG, 0, 0, 100
TFLAG:400 = 0
TFLAG:이동불능메시지 = 0
;졸리면 기력이 감소해 나간다
IF !CFLAG:MASTER:수면
	IF NEMUKE() >= 960
		BASE:MASTER:체력 = MAX(BASE:MASTER:체력 - 5 * TIME_PROGRESS(TIME:1) , 0)
		BASE:MASTER:기력 = MAX(BASE:MASTER:기력 - 10 * TIME_PROGRESS(TIME:1) , 0)
	ELSEIF NEMUKE() >= 840
		BASE:MASTER:기력 = MAX(BASE:MASTER:기력 - 2 * TIME_PROGRESS(TIME:1) , 0)
	ENDIF
ENDIF


@우후후안특수이벤트
#DIM 탈주도권확률
VARSET LOCAL
;당신 주도
SIF FLAG:개인실입장
	RETURN
IF CFLAG:TARGET:우후후 == 1 && CFLAG:욕구불만도 > 300 && !TCVAR:TARGET:억지로
;공수 역전
	IF SHIRAHU(TARGET) && TEQUIP:TARGET:체위 == 3
		;강할 만큼(정도) 확률이 높은→분모는 작다
		;1/확률
		탈주도권확률 = 15
		탈주도권확률 -= TALENT:TARGET:담력 * 2
		탈주도권확률 -= TALENT:TARGET:응답 * 2
		탈주도권확률 -= TALENT:TARGET:자존심 * 2
		탈주도권확률 += TALENT:TARGET:자제심 * 3
		탈주도권확률 -= TALENT:TARGET:성적흥미 * 3
		탈주도권확률 += TALENT:TARGET:수치심 * 2
		탈주도권확률 -= TALENT:TARGET:새드 * 5
		탈주도권확률 += TALENT:TARGET:마조 * 5

		;RAND에 건네주므로 최저치는 1
		SIF 탈주도권확률 < 1
			탈주도권확률 = 1
		IF !RAND(탈주도권확률)
			CFLAG:MASTER:우후후 = 2
			TFLAG:COMABLE관리 = 3
			FOR LOCAL, 1, CHARANUM
				IF CFLAG:MASTER:현재위치 == CFLAG:LOCAL:현재위치
					CFLAG:LOCAL:우후후 = 2
					LOCAL:1 ++
				ENDIF
			NEXT
			PRINTFORML 정신을 차려보니, %CALLNAME:TARGET%\@ LOCAL:1 > 1 ? 들 #  \@에게 주도권을 빼앗겨 있었다
		ENDIF
	ENDIF
;상대 주도
ELSEIF CFLAG:TARGET:우후후 == 2
	IF TARGET == RANDOM_CHARANUM && TALENT:TARGET:풍속양 && (BASE:기력 <= 0 || CFLAG:욕구불만도 <= 0)
		PRINTFORML %조사처리(CALLNAME:TARGET, "는")% \@ BASE:기력 <= 0 ? 조금 피곤한 # 만족스러운 \@ 모습으로 주도권을 양보해 왔다
		CFLAG:TARGET:우후후 = 1
		CFLAG:MASTER:우후후 = 1
	ELSEIF BASE:기력 <= 0
		PRINTFORML %타겟은% 조금 피곤하다고 말하며 %마스터를% 해방했다
		CALL 덮쳐지기종료("지쳤다")
	ELSEIF CFLAG:욕구불만도 <= 0 && !TCVAR:TARGET:마음대로해
		PRINTFORML %타겟은% 만족한 것 같다
		CALL KIGEN_CHANGE(TARGET, 100,1)
		BASE:분노 = 0
		CFLAG:언짢음 = 0
		CALL ASK_M("빠져나간다",1,"이쪽은 아직 만족스럽지 않다",1,"좀 더 공격해줘", ABL:새드끼 >= 3)
		SELECTCASE RESULT
			CASE 0
				PRINTFORML %타겟은% %마스터를% 해방했다
				CALL 덮쳐지기종료("만족")
			CASE 1
				PRINTFORML %마스터는% %타겟을% 밀어 넘어뜨렸다
				CALL KOJO_MESSAGE_SEND("EVENT", 30, TARGET, 3)
				FOR LOCAL, 0, CHARANUM
					CFLAG:(TARGET:LOCAL):우후후 = 1
					IF INROOM(CFLAG:MASTER:현재위치) == 2
						CALL DATUI_SHOES(LOCAL, 0)
						CALL DATUI_SHOES(MASTER, 0)
					ENDIF
				NEXT
			CASE 2
				PRINTFORML %타겟은% 눈을 가늘게 뜨고, 그러면 망가질 때까지 해주겠다고 속삭였다
				CALL KOJO_MESSAGE_SEND("EVENT", 30, TARGET, 4)
				TCVAR:TARGET:마음대로해 = 1
		ENDSELECT
	ENDIF
ENDIF

@목욕탕추방조건(ARG)
#FUNCTION
SIF FLAG:70
	RETURNF 0
SIF !GETBIT(TALENT:MASTER:2, 1) && HETEROSEX(MASTER, ARG)
	RETURNF 0
SIF TALENT:ARG:수치심 < 0 && ABL:ARG:친밀 >= 5
	RETURNF 0
SIF TALENT:ARG:무지 && ABL:ARG:친밀 >= 5
	RETURNF 0
SIF CFLAG:ARG:우후후
	RETURNF 0
SIF CFLAG:ARG:태도 < 2
	RETURNF 1
SIF CFLAG:ARG:기정사실 < 1
	RETURNF 1
SIF !(TALENT:ARG:연모 || TALENT:ARG:섹프)
	RETURNF 1

RETURNF 0
